import streamlit as st
import speech_recognition as sr
import openai
import queue
import threading
import logging
from datetime import datetime
import pandas as pd
import plotly.express as px

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(
    level=logging.INFO, 
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", 
    handlers=[logging.StreamHandler()]
)
logger = logging.getLogger(__name__)

class éŸ³å£°èªè­˜:
    def __init__(self):
        self.recognizer = sr.Recognizer()
        self.microphone = sr.Microphone()
        self.éŸ³å£°ã‚­ãƒ¥ãƒ¼ = queue.Queue()
        self.èªè­˜ä¸­ = False
        self.èªè­˜ã‚¹ãƒ¬ãƒƒãƒ‰ = None

    def _èªè­˜ã‚¹ãƒ¬ãƒƒãƒ‰(self):
        try:
            with self.microphone as source:
                logger.info("å‘¨è¾ºãƒã‚¤ã‚ºã‚’èª¿æ•´ä¸­...")
                self.recognizer.adjust_for_ambient_noise(source, duration=2)
                logger.info("éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã—ãŸ")
                while self.èªè­˜ä¸­:
                    try:
                        audio = self.recognizer.listen(source, timeout=2.0)
                        text = self.recognizer.recognize_google(audio, language='ja-JP')
                        logger.info(f"èªè­˜çµæœ: {text}")
                        self.éŸ³å£°ã‚­ãƒ¥ãƒ¼.put(text)
                    except sr.WaitTimeoutError:
                        continue
                    except sr.UnknownValueError:
                        logger.info("éŸ³å£°ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ")
                    except Exception as e:
                        logger.error(f"éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: {str(e)}")
        except Exception as e:
            logger.error(f"èªè­˜ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¨ãƒ©ãƒ¼: {str(e)}")
            self.èªè­˜ä¸­ = False

    def èªè­˜é–‹å§‹(self):
        if not self.èªè­˜ä¸­:
            self.èªè­˜ä¸­ = True
            self.èªè­˜ã‚¹ãƒ¬ãƒƒãƒ‰ = threading.Thread(target=self._èªè­˜ã‚¹ãƒ¬ãƒƒãƒ‰, daemon=True)
            self.èªè­˜ã‚¹ãƒ¬ãƒƒãƒ‰.start()

    def èªè­˜åœæ­¢(self):
        self.èªè­˜ä¸­ = False
        if self.èªè­˜ã‚¹ãƒ¬ãƒƒãƒ‰:
            self.èªè­˜ã‚¹ãƒ¬ãƒƒãƒ‰.join()

class éŸ³å£°åˆæˆ:
    def ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’(self, text):
        # å®Ÿéš›ã®éŸ³å£°å‡ºåŠ›ã¯çœç•¥ã€‚å¿…è¦ã«å¿œã˜ã¦å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã§ãã¾ã™ã€‚
        pass

class ãƒ‡ãƒ¼ã‚¿åˆ†æ:
    def __init__(self):
        self.ãƒ‡ãƒ¼ã‚¿ = []

    def ãƒ‡ãƒ¼ã‚¿è¿½åŠ (self, ãƒ†ã‚­ã‚¹ãƒˆ, æ™‚é–“):
        self.ãƒ‡ãƒ¼ã‚¿.append({"ãƒ†ã‚­ã‚¹ãƒˆ": ãƒ†ã‚­ã‚¹ãƒˆ, "æ™‚é–“": æ™‚é–“})

    def å‚¾å‘åˆ†æ(self):
        if not self.ãƒ‡ãƒ¼ã‚¿:
            return None
        
        å¯¾è©±å›æ•° = len(self.ãƒ‡ãƒ¼ã‚¿)
        å¹³å‡æ–‡å­—æ•° = sum(len(ãƒ‡ãƒ¼ã‚¿['ãƒ†ã‚­ã‚¹ãƒˆ']) for ãƒ‡ãƒ¼ã‚¿ in self.ãƒ‡ãƒ¼ã‚¿) / å¯¾è©±å›æ•°
        
        return {
            "å¯¾è©±å›æ•°": å¯¾è©±å›æ•°,
            "å¹³å‡æ–‡å­—æ•°": å¹³å‡æ–‡å­—æ•°
        }

    def ã‚°ãƒ©ãƒ•ä½œæˆ(self):
        if not self.ãƒ‡ãƒ¼ã‚¿:
            return None
        
        df = pd.DataFrame(self.ãƒ‡ãƒ¼ã‚¿)
        df['æ–‡å­—æ•°'] = df['ãƒ†ã‚­ã‚¹ãƒˆ'].str.len()
        df['æ™‚é–“'] = pd.to_datetime(df['æ™‚é–“'])
        
        fig = px.line(df, x='æ™‚é–“', y='æ–‡å­—æ•°', title='ä¼šè©±ã®æ–‡å­—æ•°æ¨ç§»')
        return fig

def main():
    st.title("ğŸŒ¸æ–°äººã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å¿œæ´ ä¼šè­°ã¡ã‚‡ã“ã£ã¨å¿œæ´ãƒ„ãƒ¼ãƒ«ğŸŒ¸")

    # OpenAI APIã‚­ãƒ¼ã®å…¥åŠ›
    api_key = st.text_input("OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password")
    if not api_key:
        st.warning("OpenAI APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™")
        return

    # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
    client = openai.OpenAI(api_key=api_key)

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
    if "éŸ³å£°èªè­˜" not in st.session_state:
        st.session_state.éŸ³å£°èªè­˜ = éŸ³å£°èªè­˜()
    if "éŸ³å£°åˆæˆ" not in st.session_state:
        st.session_state.éŸ³å£°åˆæˆ = éŸ³å£°åˆæˆ()
    if "ãƒ‡ãƒ¼ã‚¿åˆ†æ" not in st.session_state:
        st.session_state.ãƒ‡ãƒ¼ã‚¿åˆ†æ = ãƒ‡ãƒ¼ã‚¿åˆ†æ()

    # éŸ³å£°èªè­˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    col1, col2 = st.columns(2)
    with col1:
        if st.button("éŸ³å£°èªè­˜é–‹å§‹"):
            st.session_state.éŸ³å£°èªè­˜.èªè­˜é–‹å§‹()
            st.success("éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã—ãŸ")

    with col2:
        if st.button("éŸ³å£°èªè­˜åœæ­¢"):
            st.session_state.éŸ³å£°èªè­˜.èªè­˜åœæ­¢()
            st.info("éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã—ãŸ")

    # éŸ³å£°å‡¦ç†ã¨å¿œç­”ç”Ÿæˆ
    try:
        # éŸ³å£°ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        if not st.session_state.éŸ³å£°èªè­˜.éŸ³å£°ã‚­ãƒ¥ãƒ¼.empty():
            èªè­˜ãƒ†ã‚­ã‚¹ãƒˆ = st.session_state.éŸ³å£°èªè­˜.éŸ³å£°ã‚­ãƒ¥ãƒ¼.get()
            st.write(f"èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ: {èªè­˜ãƒ†ã‚­ã‚¹ãƒˆ}")

            # OpenAI APIã§ã®å¿œç­”ç”Ÿæˆ
            response = client.chat.completions.create(
                model="gpt-4-turbo-preview",
                messages=[
                    {"role": "system", "content": "ã‚ãªãŸã¯è¦ªåˆ‡ãªæ—¥æœ¬èªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚"},
                    {"role": "user", "content": èªè­˜ãƒ†ã‚­ã‚¹ãƒˆ}
                ]
            )
            ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¿œç­” = response.choices[0].message.content
            
            st.write(f"ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®å¿œç­”: {ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¿œç­”}")

            # éŸ³å£°åˆæˆï¼ˆç¾åœ¨ã¯æ©Ÿèƒ½ã—ã¦ã„ã¾ã›ã‚“ï¼‰
            st.session_state.éŸ³å£°åˆæˆ.ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’(ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¿œç­”)

            # ãƒ‡ãƒ¼ã‚¿åˆ†æç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            current_time = datetime.now()
            st.session_state.ãƒ‡ãƒ¼ã‚¿åˆ†æ.ãƒ‡ãƒ¼ã‚¿è¿½åŠ (èªè­˜ãƒ†ã‚­ã‚¹ãƒˆ, current_time)
            st.session_state.ãƒ‡ãƒ¼ã‚¿åˆ†æ.ãƒ‡ãƒ¼ã‚¿è¿½åŠ (ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¿œç­”, current_time)

            # ãƒ‡ãƒ¼ã‚¿åˆ†æã®è¡¨ç¤º
            analysis = st.session_state.ãƒ‡ãƒ¼ã‚¿åˆ†æ.å‚¾å‘åˆ†æ()
            if analysis:
                st.subheader("ä¼šè©±åˆ†æ")
                col1, col2 = st.columns(2)
                col1.metric("ç·å¯¾è©±å›æ•°", analysis["å¯¾è©±å›æ•°"])
                col2.metric("å¹³å‡æ–‡å­—æ•°", f"{analysis['å¹³å‡æ–‡å­—æ•°']:.1f}")

            graph = st.session_state.ãƒ‡ãƒ¼ã‚¿åˆ†æ.ã‚°ãƒ©ãƒ•ä½œæˆ()
            if graph:
                st.plotly_chart(graph)

    except Exception as e:
        st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")

if __name__ == "__main__":
    main()

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è¦ä»¶:
# pip install streamlit speech_recognition openai>=1.0.0 pandas plotly
# 
# éŸ³å£°èªè­˜ç”¨ã®è¿½åŠ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:
# - PyAudioã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: 
#   Mac: brew install portaudio
#   Windows: pip install pipwin && pipwin install pyaudio
#   Linux: sudo apt-get install python3-pyaudio
